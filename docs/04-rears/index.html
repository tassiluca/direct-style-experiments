<!DOCTYPE html>
<html lang="en-us" dir="ltr">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="description" content="Reactivity in direct style # So far, we&rsquo;ve explored the basics of asynchronous abstraction mechanisms provided by the direct style of the Scala Gears and Kotlin Coroutines frameworks. The goal of this last example is to investigate, using a simple example, whether these two frameworks offer sufficient idiomatic abstractions to deal with event-based reactive systems.
Smart Hub example # Idea: in an IoT context, a multitude of sensors of different types, each replicated to ensure accuracy, transmit their measurements to a central hub, which in turn needs to react, in real-time, forwarding to the appropriate controller the data, possibly performing some kind of transformation.">
<meta name="theme-color" media="(prefers-color-scheme: light)" content="#ffffff">
<meta name="theme-color" media="(prefers-color-scheme: dark)" content="#343a40">
<meta name="color-scheme" content="light dark"><meta property="og:title" content="" />
<meta property="og:description" content="Reactivity in direct style # So far, we&rsquo;ve explored the basics of asynchronous abstraction mechanisms provided by the direct style of the Scala Gears and Kotlin Coroutines frameworks. The goal of this last example is to investigate, using a simple example, whether these two frameworks offer sufficient idiomatic abstractions to deal with event-based reactive systems.
Smart Hub example # Idea: in an IoT context, a multitude of sensors of different types, each replicated to ensure accuracy, transmit their measurements to a central hub, which in turn needs to react, in real-time, forwarding to the appropriate controller the data, possibly performing some kind of transformation." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://tassiluca.github.io/PPS-22-direct-style-experiments/docs/04-rears/" /><meta property="article:section" content="docs" />

<meta property="article:modified_time" content="2024-03-04T15:26:43+01:00" />

<title>04 Rears | PPS-22-direct-style-experiments</title>
<link rel="manifest" href="/PPS-22-direct-style-experiments/manifest.json">
<link rel="icon" href="/PPS-22-direct-style-experiments/favicon.png" >
<link rel="canonical" href="https://tassiluca.github.io/PPS-22-direct-style-experiments/docs/04-rears/">
<link rel="stylesheet" href="/PPS-22-direct-style-experiments/book.min.3079c33e46bf5b308bdbfa938bf6043ba270f82b73e2ada92c1da0aacca6df5c.css" integrity="sha256-MHnDPka/WzCL2/qTi/YEO6Jw&#43;Ctz4q2pLB2gqsym31w=" crossorigin="anonymous">
  <script defer src="/PPS-22-direct-style-experiments/flexsearch.min.js"></script>
  <script defer src="/PPS-22-direct-style-experiments/en.search.min.ac27a6f81b242ca82529eb8c6965d3d892525c0d8b74d31e4fd1652cce928db6.js" integrity="sha256-rCem&#43;BskLKglKeuMaWXT2JJSXA2LdNMeT9FlLM6SjbY=" crossorigin="anonymous"></script>
<!--
Made with Book Theme
https://github.com/alex-shpak/hugo-book
-->
  
</head>
<body dir="ltr">
  <input type="checkbox" class="hidden toggle" id="menu-control" />
  <input type="checkbox" class="hidden toggle" id="toc-control" />
  <main class="container flex">
    <aside class="book-menu">
      <div class="book-menu-content">
        
  <nav>
<h2 class="book-brand">
  <a class="flex align-center" href="/PPS-22-direct-style-experiments/"><span>PPS-22-direct-style-experiments</span>
  </a>
</h2>


<div class="book-search">
  <input type="text" id="book-search-input" placeholder="Search" aria-label="Search" maxlength="64" data-hotkeys="s/" />
  <div class="book-search-spinner hidden"></div>
  <ul id="book-search-results"></ul>
</div>












  



  
  <ul>
    
      
        <li>
          
  
  

  
    <a href="/PPS-22-direct-style-experiments/docs/01-boundaries/" class="">01 Boundaries</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/PPS-22-direct-style-experiments/docs/02-basics/" class="">02 Basics</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/PPS-22-direct-style-experiments/docs/03-channels/" class="">03 Channels</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/PPS-22-direct-style-experiments/docs/04-rears/" class="active">04 Rears</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/PPS-22-direct-style-experiments/docs/05-conclusions/" class="">05 Conclusions</a>
  

        </li>
      
    
  </ul>















</nav>




  <script>(function(){var e=document.querySelector("aside .book-menu-content");addEventListener("beforeunload",function(){localStorage.setItem("menu.scrollTop",e.scrollTop)}),e.scrollTop=localStorage.getItem("menu.scrollTop")})()</script>


 
      </div>
    </aside>

    <div class="book-page">
      <header class="book-header">
        
  <div class="flex align-center justify-between">
  <label for="menu-control">
    <img src="/PPS-22-direct-style-experiments/svg/menu.svg" class="book-icon" alt="Menu" />
  </label>

  <strong>04 Rears</strong>

  <label for="toc-control">
    
  </label>
</div>


  
 
      </header>

      
      
  <article class="markdown book-article"><h1 id="reactivity-in-direct-style">
  Reactivity in direct style
  <a class="anchor" href="#reactivity-in-direct-style">#</a>
</h1>
<p>So far, we&rsquo;ve explored the basics of asynchronous abstraction mechanisms provided by the direct style of the Scala Gears and Kotlin Coroutines frameworks.
The goal of this last example is to investigate, using a simple example, whether these two frameworks offer sufficient idiomatic abstractions to deal with event-based reactive systems.</p>
<h2 id="smart-hub-example">
  Smart Hub example
  <a class="anchor" href="#smart-hub-example">#</a>
</h2>
<blockquote class="book-hint info">
  <strong>Idea</strong>: in an IoT context, a multitude of sensors of different types, each replicated to ensure accuracy, transmit their measurements to a central hub, which in turn needs to react, in real-time, forwarding to the appropriate controller the data, possibly performing some kind of transformation.
</blockquote>

<h3 id="scala-gears-version">
  Scala Gears version
  <a class="anchor" href="#scala-gears-version">#</a>
</h3>
<p>Before delving into the example, two abstractions of Gears, yet not covered, are introduced:</p>
<ul>
<li><code>Task</code>s provide a way, not only to run asynchronous computation, essentially wrapping a <code>() =&gt; Future[T]</code>, but also to schedule it, possibly repeating it. Different scheduling strategies are available: <code>Every</code>, <code>ExponentialBackoff</code>, <code>FibonacciBackoff</code>, <code>RepeatUntilFailure</code>, <code>RepeatUntilSuccess</code>.
<ul>
<li>This allows for implementing easily proactive computations</li>
</ul>
</li>
</ul>


<script src="/PPS-22-direct-style-experiments/mermaid.min.js"></script>

  <script>mermaid.initialize({
    "flowchart": {
        "useMaxWidth":true
    },
    "theme": "default"
})</script>




<p class="mermaid smaller">
classDiagram
  class `Task[+T]` {
    +apply(body: (Async, AsyncOperations) ?=> T) Task[T]$
    +run(using Async, AsyncOperations) Future[+T]
    +schedule(s: TaskSchedule) Task[T]
  }

  `Task[+T]` o--> TaskSchedule

  class TaskSchedule {
    << enum >>
    + Every(millis: Long, maxRepetitions: Long = 0)
    + ExponentialBackoff(millis: Long, exponentialBase: Int = 2, maxRepetitions: Long = 0)
    + FibonacciBackoff(millis: Long, maxRepetitions: Long = 0)
    + RepeatUntilFailure(millis: Long = 0, maxRepetitions: Long = 0)
    + RepeatUntilSuccess(millis: Long = 0, maxRepetitions: Long = 0)
  }
</p>

<blockquote class="book-hint warning">
  <p><strong>Warning</strong>: when <code>Task</code>s are scheduled with <code>RepeatUntil*</code>:</p>
<ul>
<li>if the body of a <code>Task</code> <strong>does not</strong> perform any suspending operations the <code>Async.blocking</code> <strong>blocks</strong> the current thread <strong>until the task is completed</strong> (either successfully or not);</li>
<li>if the body of a <code>Task</code> <strong>does</strong> perform suspending operations then the <code>Async.blocking</code> <strong>does not wait for the task to complete</strong> and its context is left as soon as reaches its end.
<ul>
<li>If we want to wait for the task completion, it&rsquo;s the client&rsquo;s responsibility to explicitly <code>Async.await</code> (or <code>awaitResult</code>)</li>
<li><strong>Cons</strong>: depending on the content of the block, the behavior is different! This is <em>error-prone</em>!</li>
</ul>
</li>
</ul>
</blockquote>

<blockquote class="book-hint warning">
  <strong>Warning</strong>: with high-order functions if we deal with repeated <code>Tasks</code>, in some cases an <code>Async ?=&gt;</code> label is required to not suspend the whole block, even if a suspending operation is performed: the code below <em>behaves differently</em> if the <code>Async ?=&gt;</code> label is present or not. Note: this may be an unintended effect of the library, yet to be investigated.
</blockquote>

<div class="book-columns flex flex-wrap">

  <div class="flex-even markdown-inner">
    <p>In this case despite we suspend to wait for the timer tick, the <code>Async.blocking</code> blocks until the <code>Task</code> is completed.</p>
<div class="highlight"><pre tabindex="0" style="color:#4c4f69;background-color:#eff1f5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-scala" data-lang="scala"><span style="display:flex;"><span><span style="color:#df8e1d">Async</span><span style="color:#04a5e5;font-weight:bold">.</span>blocking<span style="color:#8839ef">:</span>
</span></span><span style="display:flex;"><span>  <span style="color:#d20f39">val</span> <span style="color:#d20f39">timer</span> <span style="color:#04a5e5;font-weight:bold">=</span> <span style="color:#df8e1d">Timer</span><span style="color:#04a5e5;font-weight:bold">(</span><span style="color:#fe640b">2.</span>seconds<span style="color:#04a5e5;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>  <span style="color:#df8e1d">Future</span><span style="color:#04a5e5;font-weight:bold">(</span>timer<span style="color:#04a5e5;font-weight:bold">.</span>run<span style="color:#04a5e5;font-weight:bold">())</span>
</span></span><span style="display:flex;"><span>  produce <span style="color:#04a5e5;font-weight:bold">{</span> <span style="color:#8839ef">_</span> <span style="color:#8839ef">=&gt;</span>
</span></span><span style="display:flex;"><span>    timer<span style="color:#04a5e5;font-weight:bold">.</span>src<span style="color:#04a5e5;font-weight:bold">.</span>awaitResult <span style="color:#9ca0b0;font-style:italic">// SUSPENDING OPERATION!
</span></span></span><span style="display:flex;"><span><span style="color:#9ca0b0;font-style:italic"></span>    <span style="color:#9ca0b0;font-style:italic">// ...
</span></span></span><span style="display:flex;"><span><span style="color:#9ca0b0;font-style:italic"></span>  <span style="color:#04a5e5;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8839ef">def</span> produce<span style="color:#04a5e5;font-weight:bold">[</span><span style="color:#d20f39">T</span><span style="color:#04a5e5;font-weight:bold">](</span>
</span></span><span style="display:flex;"><span>  action<span style="color:#8839ef">:</span> <span style="color:#d20f39">SendableChannel</span><span style="color:#04a5e5;font-weight:bold">[</span><span style="color:#d20f39">T</span><span style="color:#04a5e5;font-weight:bold">]</span> <span style="color:#8839ef">=&gt;</span> <span style="color:#df8e1d">Try</span><span style="color:#04a5e5;font-weight:bold">[</span><span style="color:#d20f39">Unit</span><span style="color:#04a5e5;font-weight:bold">]</span>
</span></span><span style="display:flex;"><span><span style="color:#04a5e5;font-weight:bold">)(</span>using <span style="color:#df8e1d">Async</span><span style="color:#04a5e5;font-weight:bold">)</span><span style="color:#8839ef">:</span> <span style="color:#d20f39">ReadableChannel</span><span style="color:#04a5e5;font-weight:bold">[</span><span style="color:#d20f39">T</span><span style="color:#04a5e5;font-weight:bold">]</span> <span style="color:#8839ef">=</span>
</span></span><span style="display:flex;"><span>  <span style="color:#8839ef">val</span> channel <span style="color:#8839ef">=</span> <span style="color:#df8e1d">UnboundedChannel</span><span style="color:#04a5e5;font-weight:bold">[</span><span style="color:#d20f39">T</span><span style="color:#04a5e5;font-weight:bold">]()</span>
</span></span><span style="display:flex;"><span>  <span style="color:#df8e1d">Task</span> <span style="color:#04a5e5;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    action<span style="color:#04a5e5;font-weight:bold">(</span>channel<span style="color:#04a5e5;font-weight:bold">.</span>asSendable<span style="color:#04a5e5;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>  <span style="color:#04a5e5;font-weight:bold">}.</span>schedule<span style="color:#04a5e5;font-weight:bold">(</span><span style="color:#df8e1d">RepeatUntilFailure</span><span style="color:#04a5e5;font-weight:bold">()).</span>run
</span></span><span style="display:flex;"><span>  channel<span style="color:#04a5e5;font-weight:bold">.</span>asReadable
</span></span></code></pre></div>
  </div>

  <div class="flex-even markdown-inner">
    <p>With the <code>Async ?=&gt;</code> label, the <code>Async.blocking</code> does not wait for the <code>Task</code> to complete!</p>
<div class="highlight"><pre tabindex="0" style="color:#4c4f69;background-color:#eff1f5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-scala" data-lang="scala"><span style="display:flex;"><span><span style="color:#df8e1d">Async</span><span style="color:#04a5e5;font-weight:bold">.</span>blocking<span style="color:#8839ef">:</span>
</span></span><span style="display:flex;"><span>  <span style="color:#d20f39">val</span> <span style="color:#d20f39">timer</span> <span style="color:#04a5e5;font-weight:bold">=</span> <span style="color:#df8e1d">Timer</span><span style="color:#04a5e5;font-weight:bold">(</span><span style="color:#fe640b">2.</span>seconds<span style="color:#04a5e5;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>  <span style="color:#df8e1d">Future</span><span style="color:#04a5e5;font-weight:bold">(</span>timer<span style="color:#04a5e5;font-weight:bold">.</span>run<span style="color:#04a5e5;font-weight:bold">())</span>
</span></span><span style="display:flex;"><span>  produceWithLabel <span style="color:#04a5e5;font-weight:bold">{</span> <span style="color:#8839ef">_</span> <span style="color:#8839ef">=&gt;</span>
</span></span><span style="display:flex;"><span>    timer<span style="color:#04a5e5;font-weight:bold">.</span>src<span style="color:#04a5e5;font-weight:bold">.</span>awaitResult <span style="color:#9ca0b0;font-style:italic">// SUSPENDING OPERATION!
</span></span></span><span style="display:flex;"><span><span style="color:#9ca0b0;font-style:italic"></span>    <span style="color:#9ca0b0;font-style:italic">// ....
</span></span></span><span style="display:flex;"><span><span style="color:#9ca0b0;font-style:italic"></span>  <span style="color:#04a5e5;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8839ef">def</span> produceWithLabel<span style="color:#04a5e5;font-weight:bold">[</span><span style="color:#d20f39">T</span><span style="color:#04a5e5;font-weight:bold">](</span>
</span></span><span style="display:flex;"><span>  action<span style="color:#8839ef">:</span> <span style="color:#d20f39">Async</span> <span style="color:#d20f39">?=&gt;</span> <span style="color:#d20f39">SendableChannel</span><span style="color:#04a5e5;font-weight:bold">[</span><span style="color:#d20f39">T</span><span style="color:#04a5e5;font-weight:bold">]</span> <span style="color:#8839ef">=&gt;</span> <span style="color:#df8e1d">Try</span><span style="color:#04a5e5;font-weight:bold">[</span><span style="color:#d20f39">Unit</span><span style="color:#04a5e5;font-weight:bold">]</span>
</span></span><span style="display:flex;"><span><span style="color:#04a5e5;font-weight:bold">)(</span>using <span style="color:#df8e1d">Async</span><span style="color:#04a5e5;font-weight:bold">)</span><span style="color:#8839ef">:</span> <span style="color:#d20f39">ReadableChannel</span><span style="color:#04a5e5;font-weight:bold">[</span><span style="color:#d20f39">T</span><span style="color:#04a5e5;font-weight:bold">]</span> <span style="color:#8839ef">=</span>
</span></span><span style="display:flex;"><span>  <span style="color:#8839ef">val</span> channel <span style="color:#8839ef">=</span> <span style="color:#df8e1d">UnboundedChannel</span><span style="color:#04a5e5;font-weight:bold">[</span><span style="color:#d20f39">T</span><span style="color:#04a5e5;font-weight:bold">]()</span>
</span></span><span style="display:flex;"><span>  <span style="color:#df8e1d">Task</span> <span style="color:#04a5e5;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    action<span style="color:#04a5e5;font-weight:bold">(</span>channel<span style="color:#04a5e5;font-weight:bold">.</span>asSendable<span style="color:#04a5e5;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>  <span style="color:#04a5e5;font-weight:bold">}.</span>schedule<span style="color:#04a5e5;font-weight:bold">(</span><span style="color:#df8e1d">RepeatUntilFailure</span><span style="color:#04a5e5;font-weight:bold">()).</span>run
</span></span><span style="display:flex;"><span>  channel<span style="color:#04a5e5;font-weight:bold">.</span>asReadable
</span></span></code></pre></div>
  </div>

</div>

<p>[<a href="https://github.com/tassiLuca/PPS-22-direct-style-experiments/blob/master/commons/src/test/scala/io/github/tassiLuca/TasksTest.scala#L27">See the tests for more details.</a>]</p>
<ul>
<li>To avoid the <em>work-stealing behavior</em> of channel consumers, a <code>ChannelMultiplexer</code> can be used. It is essentially a container of <code>Readable</code> and <code>Sendable</code> channels, which can be added and removed at runtime. Internally, it is implemented with a thread that continuously races the set of publishers and once it reads a value, it forwards it to each subscriber channel.
<ul>
<li>Order is guaranteed only per producer;</li>
<li>Typically, the consumer creates a channel and adds it to the multiplexer, then starts reading from it, possibly using a scheduled task.
<ul>
<li>if the consumer attaches to the channel after the producer has started, the values sent during this interval are lost, like <em>hot observables</em> in Rx.</li>
</ul>
</li>
</ul>
</li>
</ul>


<p class="mermaid smallest">
classDiagram
  namespace javaio {
    class Closeable {
      << interface >>
      +close()
    }
  }

  class `ChannelMultiplexer[T]` {
    << trait >>
    +run()(using Async)
    +addPublisher(c: ReadableChannel[T])
    +removePublisher(c: ReadableChannel[T])
    +addSubscriber(c: SendableChannel[Try[T]])
    +removeSubscriber(c: SendableChannel[Try[T]])
  }

  Closeable <|-- `ChannelMultiplexer[T]`
</p>

<p>In the proposed strawman Scala Gears library, there are no other kinds of abstractions, nor a way to manipulate channels with functions inspired by Rx.</p>
<p>The attempt, described in the following, has been to extend this framework adding first-class support for <code>Producer</code> and <code>Consumer</code>&rsquo;s concepts and implementing some of the most common Rx operators, completely leaving out performance concerns.</p>
<p><a href="https://github.com/tassiLuca/PPS-22-direct-style-experiments/tree/master/rears/src/main/scala/io/github/tassiLuca/rears">[Sources can be found in the <code>rears</code> submodule.]</a></p>
<ul>
<li>A <code>Producer</code> is a runnable entity, programmed with a <code>Task</code>, producing items on a channel. It exposes the <code>publishingChannel</code> method, which returns a <code>ReadableChannel</code> through which interested consumers can read produced items.</li>
<li>A <code>Consumer</code> is a runnable entity devoted to consuming data from a channel, exposed by the <code>listeningChannel</code> method which returns a <code>SendableChannel</code> to send items to.
<ul>
<li>It can be made stateful by mixing it with the <code>State</code> trait, allowing it to keep track of its state, which is updated every time with the result of the <code>react</code>ion (i.e. its return type).</li>
<li><strong>Warning</strong>: like in an event-loop, the <code>react</code>ion logic should not perform long-lasting blocking operation, otherwise, the whole system will not react to new events.</li>
</ul>
</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#4c4f69;background-color:#eff1f5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-scala" data-lang="scala"><span style="display:flex;"><span><span style="color:#9ca0b0;font-style:italic">/** A producer, i.e. a runnable entity producing items on a channel. */</span>
</span></span><span style="display:flex;"><span><span style="color:#8839ef">trait</span> <span style="color:#df8e1d">Producer</span><span style="color:#04a5e5;font-weight:bold">[</span><span style="color:#d20f39">E</span><span style="color:#04a5e5;font-weight:bold">]</span><span style="color:#df8e1d">:</span>
</span></span><span style="display:flex;"><span>  <span style="color:#9ca0b0;font-style:italic">/** The [[Channel]] where specific [[Producer]]s send items to. */</span>
</span></span><span style="display:flex;"><span>  <span style="color:#8839ef">protected</span> <span style="color:#8839ef">val</span> channel<span style="color:#8839ef">:</span> <span style="color:#d20f39">Channel</span><span style="color:#04a5e5;font-weight:bold">[</span><span style="color:#d20f39">E</span><span style="color:#04a5e5;font-weight:bold">]</span> <span style="color:#8839ef">=</span> <span style="color:#df8e1d">UnboundedChannel</span><span style="color:#04a5e5;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#9ca0b0;font-style:italic">/** @return the publisher&#39;s behavior encoded as a runnable [[Task]]. */</span>
</span></span><span style="display:flex;"><span>  <span style="color:#8839ef">def</span> asRunnable<span style="color:#8839ef">:</span> <span style="color:#d20f39">Task</span><span style="color:#04a5e5;font-weight:bold">[</span><span style="color:#d20f39">Unit</span><span style="color:#04a5e5;font-weight:bold">]</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#9ca0b0;font-style:italic">/** @return the [[ReadableChannel]] where produced items are placed. */</span>
</span></span><span style="display:flex;"><span>  <span style="color:#8839ef">def</span> publishingChannel<span style="color:#8839ef">:</span> <span style="color:#d20f39">ReadableChannel</span><span style="color:#04a5e5;font-weight:bold">[</span><span style="color:#d20f39">E</span><span style="color:#04a5e5;font-weight:bold">]</span> <span style="color:#8839ef">=</span> channel<span style="color:#04a5e5;font-weight:bold">.</span>asReadable
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#9ca0b0;font-style:italic">/** A consumer, i.e. a runnable entity devoted to consume data from a channel. */</span>
</span></span><span style="display:flex;"><span><span style="color:#8839ef">trait</span> <span style="color:#df8e1d">Consumer</span><span style="color:#04a5e5;font-weight:bold">[</span><span style="color:#d20f39">E</span>, <span style="color:#d20f39">S</span><span style="color:#04a5e5;font-weight:bold">]</span><span style="color:#df8e1d">:</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#9ca0b0;font-style:italic">/** The [[SendableChannel]] to send items to, where the consumer listen for new items. */</span>
</span></span><span style="display:flex;"><span>  <span style="color:#8839ef">val</span> listeningChannel<span style="color:#8839ef">:</span> <span style="color:#d20f39">SendableChannel</span><span style="color:#04a5e5;font-weight:bold">[</span><span style="color:#d20f39">Try</span><span style="color:#04a5e5;font-weight:bold">[</span><span style="color:#d20f39">E</span><span style="color:#04a5e5;font-weight:bold">]]</span> <span style="color:#8839ef">=</span> <span style="color:#df8e1d">UnboundedChannel</span><span style="color:#04a5e5;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#9ca0b0;font-style:italic">/** @return a runnable [[Task]]. */</span>
</span></span><span style="display:flex;"><span>  <span style="color:#8839ef">def</span> asRunnable<span style="color:#8839ef">:</span> <span style="color:#d20f39">Task</span><span style="color:#04a5e5;font-weight:bold">[</span><span style="color:#d20f39">Unit</span><span style="color:#04a5e5;font-weight:bold">]</span> <span style="color:#8839ef">=</span> <span style="color:#df8e1d">Task</span> <span style="color:#04a5e5;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    listeningChannel<span style="color:#04a5e5;font-weight:bold">.</span>asInstanceOf<span style="color:#04a5e5;font-weight:bold">[</span><span style="color:#d20f39">Channel</span><span style="color:#04a5e5;font-weight:bold">[</span><span style="color:#d20f39">Try</span><span style="color:#04a5e5;font-weight:bold">[</span><span style="color:#d20f39">E</span><span style="color:#04a5e5;font-weight:bold">]]].</span>read<span style="color:#04a5e5;font-weight:bold">().</span>foreach<span style="color:#04a5e5;font-weight:bold">(</span>react<span style="color:#04a5e5;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>  <span style="color:#04a5e5;font-weight:bold">}.</span>schedule<span style="color:#04a5e5;font-weight:bold">(</span><span style="color:#df8e1d">RepeatUntilFailure</span><span style="color:#04a5e5;font-weight:bold">())</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#9ca0b0;font-style:italic">/** The suspendable reaction triggered upon a new read of an item succeeds. */</span>
</span></span><span style="display:flex;"><span>  <span style="color:#8839ef">protected</span> <span style="color:#8839ef">def</span> react<span style="color:#04a5e5;font-weight:bold">(</span>e<span style="color:#8839ef">:</span> <span style="color:#d20f39">Try</span><span style="color:#04a5e5;font-weight:bold">[</span><span style="color:#d20f39">E</span><span style="color:#04a5e5;font-weight:bold">])(</span>using <span style="color:#df8e1d">Async</span><span style="color:#04a5e5;font-weight:bold">)</span><span style="color:#8839ef">:</span> <span style="color:#d20f39">S</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#9ca0b0;font-style:italic">/** A mixin to make consumer stateful. Its state is updated with the result
</span></span></span><span style="display:flex;"><span><span style="color:#9ca0b0;font-style:italic">  * of the [[react]]ion. Initially its state is set to [[initialValue]].
</span></span></span><span style="display:flex;"><span><span style="color:#9ca0b0;font-style:italic">  */</span>
</span></span><span style="display:flex;"><span><span style="color:#8839ef">trait</span> <span style="color:#df8e1d">State</span><span style="color:#04a5e5;font-weight:bold">[</span><span style="color:#d20f39">E</span>, <span style="color:#d20f39">S</span><span style="color:#04a5e5;font-weight:bold">](</span>initialValue<span style="color:#8839ef">:</span> <span style="color:#d20f39">S</span><span style="color:#04a5e5;font-weight:bold">)</span><span style="color:#8839ef">:</span>
</span></span><span style="display:flex;"><span>  <span style="color:#d20f39">consumer:</span> <span style="color:#d20f39">Consumer</span><span style="color:#04a5e5;font-weight:bold">[</span><span style="color:#d20f39">E</span>, <span style="color:#d20f39">S</span><span style="color:#04a5e5;font-weight:bold">]</span> <span style="color:#8839ef">=&gt;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#8839ef">private</span> <span style="color:#8839ef">var</span> <span style="color:#df8e1d">_state</span><span style="color:#8839ef">:</span> <span style="color:#d20f39">S</span> <span style="color:#04a5e5;font-weight:bold">=</span> initialValue
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#9ca0b0;font-style:italic">/** @return the current state of the consumer. */</span>
</span></span><span style="display:flex;"><span>  <span style="color:#8839ef">def</span> state<span style="color:#8839ef">:</span> <span style="color:#d20f39">S</span> <span style="color:#04a5e5;font-weight:bold">=</span> synchronized<span style="color:#04a5e5;font-weight:bold">(</span><span style="color:#df8e1d">_state</span><span style="color:#04a5e5;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#8839ef">override</span> <span style="color:#8839ef">def</span> asRunnable<span style="color:#8839ef">:</span> <span style="color:#d20f39">Task</span><span style="color:#04a5e5;font-weight:bold">[</span><span style="color:#d20f39">Unit</span><span style="color:#04a5e5;font-weight:bold">]</span> <span style="color:#8839ef">=</span> <span style="color:#df8e1d">Task</span> <span style="color:#04a5e5;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    listeningChannel<span style="color:#04a5e5;font-weight:bold">.</span>asInstanceOf<span style="color:#04a5e5;font-weight:bold">[</span><span style="color:#d20f39">Channel</span><span style="color:#04a5e5;font-weight:bold">[</span><span style="color:#d20f39">Try</span><span style="color:#04a5e5;font-weight:bold">[</span><span style="color:#d20f39">E</span><span style="color:#04a5e5;font-weight:bold">]]].</span>read<span style="color:#04a5e5;font-weight:bold">().</span>foreach <span style="color:#04a5e5;font-weight:bold">{</span> e <span style="color:#8839ef">=&gt;</span>
</span></span><span style="display:flex;"><span>      synchronized <span style="color:#04a5e5;font-weight:bold">{</span> <span style="color:#df8e1d">_state</span> <span style="color:#8839ef">=</span> react<span style="color:#04a5e5;font-weight:bold">(</span>e<span style="color:#04a5e5;font-weight:bold">)</span> <span style="color:#04a5e5;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#04a5e5;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>  <span style="color:#04a5e5;font-weight:bold">}.</span>schedule<span style="color:#04a5e5;font-weight:bold">(</span><span style="color:#df8e1d">RepeatUntilFailure</span><span style="color:#04a5e5;font-weight:bold">())</span>
</span></span></code></pre></div><ul>
<li>The <code>Controller</code> object exposes methods wiring <code>Producer</code> and <code>Consumer</code>s altogether, possibly performing some kind of transformation on the <code>publisherChannel</code>.
<ul>
<li>the <code>oneToOne</code> method just wires one single consumer to the <code>publisherChannel</code> given in input, possibly having it transformed with the provided transformation.</li>
<li>the <code>oneToMany</code> allows many consumers to be wired to the <code>publisherChannel</code>, possibly having it transformed.
<ul>
<li>to accomplish this, a <code>ChannelMultiplexer</code> is used, which is in charge of forwarding the items read from the transformed <code>publisherChannel</code> to all consumers&rsquo; channels.</li>
</ul>
</li>
</ul>
</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#4c4f69;background-color:#eff1f5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-scala" data-lang="scala"><span style="display:flex;"><span><span style="color:#9ca0b0;font-style:italic">/** Simply, a function that, given in input a [[ReadableChannel]], performs some 
</span></span></span><span style="display:flex;"><span><span style="color:#9ca0b0;font-style:italic">  * kind of transformation, returning, as a result, another [[ReadableChannel]]. */</span>
</span></span><span style="display:flex;"><span><span style="color:#8839ef">type</span> <span style="color:#d20f39">PipelineTransformation</span><span style="color:#04a5e5;font-weight:bold">[</span><span style="color:#d20f39">T</span>, <span style="color:#d20f39">R</span><span style="color:#04a5e5;font-weight:bold">]</span> <span style="color:#8839ef">=</span> <span style="color:#df8e1d">ReadableChannel</span><span style="color:#04a5e5;font-weight:bold">[</span><span style="color:#d20f39">T</span><span style="color:#04a5e5;font-weight:bold">]</span> <span style="color:#8839ef">=&gt;</span> <span style="color:#df8e1d">ReadableChannel</span><span style="color:#04a5e5;font-weight:bold">[</span><span style="color:#d20f39">R</span><span style="color:#04a5e5;font-weight:bold">]</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8839ef">object</span> <span style="color:#df8e1d">Controller</span><span style="color:#8839ef">:</span>
</span></span><span style="display:flex;"><span>  <span style="color:#d20f39">/**</span> <span style="color:#d20f39">Creates</span> <span style="color:#d20f39">a</span> <span style="color:#d20f39">runnable</span> <span style="color:#04a5e5;font-weight:bold">[[</span><span style="color:#d20f39">Task</span><span style="color:#04a5e5;font-weight:bold">]]</span> forwarding the items read from the <span style="color:#04a5e5;font-weight:bold">[[</span><span style="color:#d20f39">publisherChannel</span><span style="color:#04a5e5;font-weight:bold">]]</span> 
</span></span><span style="display:flex;"><span>    <span style="color:#04a5e5;font-weight:bold">*</span> to the given <span style="color:#04a5e5;font-weight:bold">[[</span><span style="color:#d20f39">consumer</span><span style="color:#04a5e5;font-weight:bold">]],</span> after having it transformed <span style="color:#8839ef">with</span> the given <span style="color:#04a5e5;font-weight:bold">[[</span><span style="color:#d20f39">transformation</span><span style="color:#04a5e5;font-weight:bold">]].</span>
</span></span><span style="display:flex;"><span>    <span style="color:#04a5e5;font-weight:bold">*/</span>
</span></span><span style="display:flex;"><span>  <span style="color:#8839ef">def</span> oneToOne<span style="color:#04a5e5;font-weight:bold">[</span><span style="color:#d20f39">T</span>, <span style="color:#d20f39">R</span><span style="color:#04a5e5;font-weight:bold">](</span>
</span></span><span style="display:flex;"><span>      publisherChannel<span style="color:#8839ef">:</span> <span style="color:#d20f39">ReadableChannel</span><span style="color:#04a5e5;font-weight:bold">[</span><span style="color:#d20f39">T</span><span style="color:#04a5e5;font-weight:bold">],</span>
</span></span><span style="display:flex;"><span>      consumer<span style="color:#8839ef">:</span> <span style="color:#d20f39">Consumer</span><span style="color:#04a5e5;font-weight:bold">[</span><span style="color:#d20f39">R</span>, <span style="color:#d20f39">?</span><span style="color:#04a5e5;font-weight:bold">],</span>
</span></span><span style="display:flex;"><span>      transformation<span style="color:#8839ef">:</span> <span style="color:#d20f39">PipelineTransformation</span><span style="color:#04a5e5;font-weight:bold">[</span><span style="color:#d20f39">T</span>, <span style="color:#d20f39">R</span><span style="color:#04a5e5;font-weight:bold">]</span> <span style="color:#8839ef">=</span> identity<span style="color:#04a5e5;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>  <span style="color:#04a5e5;font-weight:bold">)</span><span style="color:#8839ef">:</span> <span style="color:#d20f39">Task</span><span style="color:#04a5e5;font-weight:bold">[</span><span style="color:#d20f39">Unit</span><span style="color:#04a5e5;font-weight:bold">]</span> <span style="color:#8839ef">=</span>
</span></span><span style="display:flex;"><span>    <span style="color:#8839ef">val</span> transformedChannel <span style="color:#8839ef">=</span> transformation<span style="color:#04a5e5;font-weight:bold">(</span>publisherChannel<span style="color:#04a5e5;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#df8e1d">Task</span> <span style="color:#04a5e5;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>      consumer<span style="color:#04a5e5;font-weight:bold">.</span>listeningChannel<span style="color:#04a5e5;font-weight:bold">.</span>send<span style="color:#04a5e5;font-weight:bold">(</span>transformedChannel<span style="color:#04a5e5;font-weight:bold">.</span>read<span style="color:#04a5e5;font-weight:bold">().</span>tryable<span style="color:#04a5e5;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#04a5e5;font-weight:bold">}.</span>schedule<span style="color:#04a5e5;font-weight:bold">(</span><span style="color:#df8e1d">RepeatUntilFailure</span><span style="color:#04a5e5;font-weight:bold">())</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#9ca0b0;font-style:italic">/** Creates a runnable [[Task]] forwarding the items read from the [[publisherChannel]] to 
</span></span></span><span style="display:flex;"><span><span style="color:#9ca0b0;font-style:italic">    * all consumers&#39; channels, after having it transformed with the given [[transformation]].
</span></span></span><span style="display:flex;"><span><span style="color:#9ca0b0;font-style:italic">    */</span>
</span></span><span style="display:flex;"><span>  <span style="color:#8839ef">def</span> oneToMany<span style="color:#04a5e5;font-weight:bold">[</span><span style="color:#d20f39">T</span>, <span style="color:#d20f39">R</span><span style="color:#04a5e5;font-weight:bold">](</span>
</span></span><span style="display:flex;"><span>      publisherChannel<span style="color:#8839ef">:</span> <span style="color:#d20f39">ReadableChannel</span><span style="color:#04a5e5;font-weight:bold">[</span><span style="color:#d20f39">T</span><span style="color:#04a5e5;font-weight:bold">],</span>
</span></span><span style="display:flex;"><span>      consumers<span style="color:#8839ef">:</span> <span style="color:#d20f39">Set</span><span style="color:#04a5e5;font-weight:bold">[</span><span style="color:#d20f39">Consumer</span><span style="color:#04a5e5;font-weight:bold">[</span><span style="color:#d20f39">R</span>, <span style="color:#d20f39">?</span><span style="color:#04a5e5;font-weight:bold">]],</span>
</span></span><span style="display:flex;"><span>      transformation<span style="color:#8839ef">:</span> <span style="color:#d20f39">PipelineTransformation</span><span style="color:#04a5e5;font-weight:bold">[</span><span style="color:#d20f39">T</span>, <span style="color:#d20f39">R</span><span style="color:#04a5e5;font-weight:bold">]</span> <span style="color:#8839ef">=</span> identity<span style="color:#04a5e5;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>  <span style="color:#04a5e5;font-weight:bold">)</span><span style="color:#8839ef">:</span> <span style="color:#d20f39">Task</span><span style="color:#04a5e5;font-weight:bold">[</span><span style="color:#d20f39">Unit</span><span style="color:#04a5e5;font-weight:bold">]</span> <span style="color:#8839ef">=</span> <span style="color:#df8e1d">Task</span><span style="color:#8839ef">:</span>
</span></span><span style="display:flex;"><span>    <span style="color:#d20f39">val</span> <span style="color:#d20f39">multiplexer</span> <span style="color:#04a5e5;font-weight:bold">=</span> <span style="color:#df8e1d">ChannelMultiplexer</span><span style="color:#04a5e5;font-weight:bold">[</span><span style="color:#d20f39">R</span><span style="color:#04a5e5;font-weight:bold">]()</span>
</span></span><span style="display:flex;"><span>    consumers<span style="color:#04a5e5;font-weight:bold">.</span>foreach<span style="color:#04a5e5;font-weight:bold">(</span>c <span style="color:#8839ef">=&gt;</span> multiplexer<span style="color:#04a5e5;font-weight:bold">.</span>addSubscriber<span style="color:#04a5e5;font-weight:bold">(</span>c<span style="color:#04a5e5;font-weight:bold">.</span>listeningChannel<span style="color:#04a5e5;font-weight:bold">))</span>
</span></span><span style="display:flex;"><span>    multiplexer<span style="color:#04a5e5;font-weight:bold">.</span>addPublisher<span style="color:#04a5e5;font-weight:bold">(</span>transformation<span style="color:#04a5e5;font-weight:bold">(</span>publisherChannel<span style="color:#04a5e5;font-weight:bold">))</span>
</span></span><span style="display:flex;"><span>    <span style="color:#9ca0b0;font-style:italic">// blocking call: the virtual thread on top of which this task is 
</span></span></span><span style="display:flex;"><span><span style="color:#9ca0b0;font-style:italic"></span>    <span style="color:#9ca0b0;font-style:italic">// executed needs to block to continue publishing publisher&#39;s events 
</span></span></span><span style="display:flex;"><span><span style="color:#9ca0b0;font-style:italic"></span>    <span style="color:#9ca0b0;font-style:italic">// towards the consumer by means of the multiplexer.
</span></span></span><span style="display:flex;"><span><span style="color:#9ca0b0;font-style:italic"></span>    multiplexer<span style="color:#04a5e5;font-weight:bold">.</span>run<span style="color:#04a5e5;font-weight:bold">()</span>
</span></span></code></pre></div><p>The following <code>PipelineTransformation</code>s have been implemented (inspired by Rx). <a href="https://github.com/tassiLuca/PPS-22-direct-style-experiments/blob/master/rears/src/test/scala/io/github/tassiLuca/rears/PipelineTransformationsTest.scala">Tests in <code>rears</code> submodule</a> provide the necessary examples to understand their behavior.</p>
<h4 id="filter">
  Filter
  <a class="anchor" href="#filter">#</a>
</h4>
<div class="highlight"><pre tabindex="0" style="color:#4c4f69;background-color:#eff1f5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-scala" data-lang="scala"><span style="display:flex;"><span><span style="color:#9ca0b0;font-style:italic">/** @return a new [[ReadableChannel]] whose elements passes the given predicate [[p]].  */</span>
</span></span><span style="display:flex;"><span><span style="color:#8839ef">def</span> filter<span style="color:#04a5e5;font-weight:bold">(</span>p<span style="color:#8839ef">:</span> <span style="color:#d20f39">T</span> <span style="color:#04a5e5;font-weight:bold">=&gt;</span> <span style="color:#df8e1d">Boolean</span><span style="color:#04a5e5;font-weight:bold">)</span><span style="color:#8839ef">:</span> <span style="color:#d20f39">ReadableChannel</span><span style="color:#04a5e5;font-weight:bold">[</span><span style="color:#d20f39">T</span><span style="color:#04a5e5;font-weight:bold">]</span>
</span></span></code></pre></div><p>Example:</p>
<pre tabindex="0"><code>----1---2-------3----4---5--6----7---8---9---10---&gt;
    |   |       |    |   |  |    |   |   |   |
----V---V-------V----V---V--V----V---V---V---V-----
                filter(_ % 2 == 0)
--------|--------------|------|-------|---------|--
        V              V      V       V         V
--------2--------------4------6-------8--------10-&gt;
</code></pre><h4 id="map">
  Map
  <a class="anchor" href="#map">#</a>
</h4>
<div class="highlight"><pre tabindex="0" style="color:#4c4f69;background-color:#eff1f5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-scala" data-lang="scala"><span style="display:flex;"><span><span style="color:#9ca0b0;font-style:italic">/** @return a new [[ReadableChannel]] whose values are transformed accordingly to the given function [[f]]. */</span>
</span></span><span style="display:flex;"><span><span style="color:#8839ef">def</span> map<span style="color:#04a5e5;font-weight:bold">[</span><span style="color:#d20f39">R</span><span style="color:#04a5e5;font-weight:bold">](</span>f<span style="color:#8839ef">:</span> <span style="color:#d20f39">T</span> <span style="color:#04a5e5;font-weight:bold">=&gt;</span> R<span style="color:#04a5e5;font-weight:bold">)</span><span style="color:#8839ef">:</span> <span style="color:#d20f39">ReadableChannel</span><span style="color:#04a5e5;font-weight:bold">[</span><span style="color:#d20f39">R</span><span style="color:#04a5e5;font-weight:bold">]</span>
</span></span></code></pre></div><p>Example:</p>
<pre tabindex="0"><code>----1---2-------3----4---5------6--------7--------&gt;
    |   |       |    |   |      |        |
----V---V-------V----V---V------V--------V---------
                map(x =&gt; x * x)
----|---|-------|----|---|------|--------|---------
    V   V       V    V   V      V        V
----1---4-------9----16--25-----36-------49-------&gt;
</code></pre><h4 id="debounce">
  Debounce
  <a class="anchor" href="#debounce">#</a>
</h4>
<div class="highlight"><pre tabindex="0" style="color:#4c4f69;background-color:#eff1f5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-scala" data-lang="scala"><span style="display:flex;"><span><span style="color:#9ca0b0;font-style:italic">/** @return a new [[ReadableChannel]] whose elements are emitted only after
</span></span></span><span style="display:flex;"><span><span style="color:#9ca0b0;font-style:italic">  *         the given [[timespan]] has elapsed since the last emission. */</span>
</span></span><span style="display:flex;"><span><span style="color:#8839ef">def</span> debounce<span style="color:#04a5e5;font-weight:bold">(</span>timespan<span style="color:#8839ef">:</span> <span style="color:#d20f39">Duration</span><span style="color:#04a5e5;font-weight:bold">)</span><span style="color:#8839ef">:</span> <span style="color:#d20f39">ReadableChannel</span><span style="color:#04a5e5;font-weight:bold">[</span><span style="color:#d20f39">T</span><span style="color:#04a5e5;font-weight:bold">]</span>
</span></span></code></pre></div><p>Example:</p>
<pre tabindex="0"><code>----1---2-------3----4---5--6-----7---8---9---10--&gt;
    |   |       |    |   |  |     |   |   |   |
    V   V       V    V   V  V     V   V   V   V
T----------T----------T----------T----------T------
                debounce(1 second)
---------------------------------------------------
       |         |         |      |             |
       V         V         V      V             V
-------1---------3---------5------7------------10-&gt;
</code></pre><h4 id="groupby">
  GroupBy
  <a class="anchor" href="#groupby">#</a>
</h4>
<div class="highlight"><pre tabindex="0" style="color:#4c4f69;background-color:#eff1f5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-scala" data-lang="scala"><span style="display:flex;"><span><span style="color:#9ca0b0;font-style:italic">/** Groups the items emitted by a [[ReadableChannel]] according to the given [[keySelector]].
</span></span></span><span style="display:flex;"><span><span style="color:#9ca0b0;font-style:italic">  * @return key-value pairs, where the keys are the set of results obtained from applying the
</span></span></span><span style="display:flex;"><span><span style="color:#9ca0b0;font-style:italic">  *         [[keySelector]] coupled to a new [[ReadableChannel]] where only items belonging to
</span></span></span><span style="display:flex;"><span><span style="color:#9ca0b0;font-style:italic">  *         that grouping are emitted.
</span></span></span><span style="display:flex;"><span><span style="color:#9ca0b0;font-style:italic">  */</span>
</span></span><span style="display:flex;"><span><span style="color:#8839ef">def</span> groupBy<span style="color:#04a5e5;font-weight:bold">[</span><span style="color:#d20f39">K</span><span style="color:#04a5e5;font-weight:bold">](</span>keySelector<span style="color:#8839ef">:</span> <span style="color:#d20f39">T</span> <span style="color:#04a5e5;font-weight:bold">=&gt;</span> K<span style="color:#04a5e5;font-weight:bold">)</span><span style="color:#8839ef">:</span> <span style="color:#d20f39">ReadableChannel</span><span style="color:#04a5e5;font-weight:bold">[(</span><span style="color:#d20f39">K</span>, <span style="color:#d20f39">ReadableChannel</span><span style="color:#04a5e5;font-weight:bold">[</span><span style="color:#d20f39">T</span><span style="color:#04a5e5;font-weight:bold">])]</span>
</span></span></code></pre></div><p>Example:</p>
<pre tabindex="0"><code>----1---2-3--4---5--6---&gt;
    |   | |  |   |  |
    V   V V  V   V  V
-------------------------
       groupBy(_ % 2)
-------------------------
     \     \
----false--true------------&gt;
       1     2
        \     \
         \     4
          3     \
           \     \
            5     6
</code></pre><h4 id="buffer">
  Buffer
  <a class="anchor" href="#buffer">#</a>
</h4>
<div class="highlight"><pre tabindex="0" style="color:#4c4f69;background-color:#eff1f5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-scala" data-lang="scala"><span style="display:flex;"><span><span style="color:#9ca0b0;font-style:italic">/** @return a new [[ReadableChannel]] whose elements are buffered in a [[List]] of size [[n]].
</span></span></span><span style="display:flex;"><span><span style="color:#9ca0b0;font-style:italic">  *         If [[timespan]] duration is elapsed since last read the list is emitted
</span></span></span><span style="display:flex;"><span><span style="color:#9ca0b0;font-style:italic">  *         with collected elements until that moment (default: 5 seconds).
</span></span></span><span style="display:flex;"><span><span style="color:#9ca0b0;font-style:italic">  */</span>
</span></span><span style="display:flex;"><span><span style="color:#8839ef">def</span> buffer<span style="color:#04a5e5;font-weight:bold">(</span>n<span style="color:#8839ef">:</span> <span style="color:#d20f39">Int</span><span style="color:#04a5e5;font-weight:bold">,</span> timespan<span style="color:#8839ef">:</span> <span style="color:#d20f39">Duration</span> <span style="color:#04a5e5;font-weight:bold">=</span> <span style="color:#fe640b">5</span> seconds<span style="color:#04a5e5;font-weight:bold">)</span><span style="color:#8839ef">:</span> <span style="color:#d20f39">ReadableChannel</span><span style="color:#04a5e5;font-weight:bold">[</span><span style="color:#d20f39">List</span><span style="color:#04a5e5;font-weight:bold">[</span><span style="color:#d20f39">T</span><span style="color:#04a5e5;font-weight:bold">]]</span>
</span></span></code></pre></div><p>Example:</p>
<pre tabindex="0"><code>----1---2-3----4---5--6----7---8--------&gt;
    |   | |    |   |  |    |   |
    V   V V    V   V  V    V   V
|---------|-----------|------------T-----
   buffer(n = 3, timespan = 5 seconds)
|---------|-----------|------------|-----
          V           V            V
------[1, 2, 3]---[4, 5, 6]------[7, 8]-&gt;
</code></pre><h4 id="bufferwithin">
  BufferWithin
  <a class="anchor" href="#bufferwithin">#</a>
</h4>
<div class="highlight"><pre tabindex="0" style="color:#4c4f69;background-color:#eff1f5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-scala" data-lang="scala"><span style="display:flex;"><span><span style="color:#9ca0b0;font-style:italic">/** @return a new [[ReadableChannel]] whose elements are buffered in a [[List]] of items
</span></span></span><span style="display:flex;"><span><span style="color:#9ca0b0;font-style:italic">  *         if emitted within [[timespan]] duration after the first one (default: 5 seconds).
</span></span></span><span style="display:flex;"><span><span style="color:#9ca0b0;font-style:italic">  */</span>
</span></span><span style="display:flex;"><span><span style="color:#8839ef">def</span> bufferWithin<span style="color:#04a5e5;font-weight:bold">(</span>timespan<span style="color:#8839ef">:</span> <span style="color:#d20f39">Duration</span> <span style="color:#04a5e5;font-weight:bold">=</span> <span style="color:#fe640b">5</span> seconds<span style="color:#04a5e5;font-weight:bold">)</span><span style="color:#8839ef">:</span> <span style="color:#d20f39">ReadableChannel</span><span style="color:#04a5e5;font-weight:bold">[</span><span style="color:#d20f39">List</span><span style="color:#04a5e5;font-weight:bold">[</span><span style="color:#d20f39">T</span><span style="color:#04a5e5;font-weight:bold">]]</span>
</span></span></code></pre></div><p>Example:</p>
<pre tabindex="0"><code>----1---2-3-4---5--6--7----------8-----------&gt;
    |   | | |   |  |  |          |
    V   V V V   V  V  V          V
----|--------T--|--------T-------|--------T---
         buffer(timespan = 5 seconds)
-------------|-----------|----------------|---
             V           V                V
-------[1, 2, 3, 4]--[5, 6, 7]-----------[8]-&gt;
</code></pre><p>Going back to the example here is presented a schema summarizing the flows of data and the transformations to apply to them. This is just a simple example used to test the proposed abstractions.</p>
<figure class="center"><img src="../../res/img/rears.svg"
         alt="System design of the example" width="90%"/>
</figure>

<p>[<a href="https://github.com/tassiLuca/PPS-22-direct-style-experiments/tree/master/smart-hub-direct/src/main/scala/io/github/tassiLuca/hub">Sources are available in <code>smart-hub-direct</code> submodule</a>].</p>
<ul>
<li>
<p>For simplicity, two types of sensors are considered: <code>TemperatureSensor</code> and <code>LuminositySensor</code>;</p>
</li>
<li>
<p>sensors send data to the smart hub <code>SensorSource</code> (e.g., in a real case scenario, via MQTT)</p>
<ul>
<li>
<p><code>SensorSource</code> is a <code>Producer[SensorEvent]</code>, publishing received data on its <code>publishingChannel</code>:</p>
<div class="highlight"><pre tabindex="0" style="color:#4c4f69;background-color:#eff1f5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-scala" data-lang="scala"><span style="display:flex;"><span><span style="color:#8839ef">trait</span> <span style="color:#df8e1d">SensorSource</span> <span style="color:#8839ef">extends</span> <span style="color:#df8e1d">Producer</span><span style="color:#04a5e5;font-weight:bold">[</span><span style="color:#d20f39">SensorEvent</span><span style="color:#04a5e5;font-weight:bold">]</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8839ef">sealed</span> <span style="color:#8839ef">trait</span> <span style="color:#df8e1d">SensorEvent</span><span style="color:#04a5e5;font-weight:bold">(</span><span style="color:#8839ef">val</span> name<span style="color:#8839ef">:</span> <span style="color:#d20f39">String</span><span style="color:#04a5e5;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#8839ef">case</span> <span style="color:#8839ef">class</span> <span style="color:#df8e1d">TemperatureEntry</span><span style="color:#04a5e5;font-weight:bold">(</span>sensorName<span style="color:#8839ef">:</span> <span style="color:#d20f39">String</span><span style="color:#04a5e5;font-weight:bold">,</span> temperature<span style="color:#8839ef">:</span> <span style="color:#d20f39">Temperature</span><span style="color:#04a5e5;font-weight:bold">)</span> 
</span></span><span style="display:flex;"><span>  <span style="color:#8839ef">extends</span> <span style="color:#df8e1d">SensorEvent</span><span style="color:#04a5e5;font-weight:bold">(</span>sensorName<span style="color:#04a5e5;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#8839ef">case</span> <span style="color:#8839ef">class</span> <span style="color:#df8e1d">LuminosityEntry</span><span style="color:#04a5e5;font-weight:bold">(</span>sensorName<span style="color:#8839ef">:</span> <span style="color:#d20f39">String</span><span style="color:#04a5e5;font-weight:bold">,</span> luminosity<span style="color:#8839ef">:</span> <span style="color:#d20f39">Temperature</span><span style="color:#04a5e5;font-weight:bold">)</span> 
</span></span><span style="display:flex;"><span>  <span style="color:#8839ef">extends</span> <span style="color:#df8e1d">SensorEvent</span><span style="color:#04a5e5;font-weight:bold">(</span>sensorName<span style="color:#04a5e5;font-weight:bold">)</span>
</span></span></code></pre></div></li>
</ul>
</li>
<li>
<p>three main controllers:</p>
<ul>
<li>
<p><code>SensorHealthChecker</code> is a stateful consumer of generic <code>SensorEvent</code>s that checks the health of the sensors, sending alerts in case of malfunctioning. Here the state is necessary to determine the health of the sensors, based on the last detection.</p>
<div class="highlight"><pre tabindex="0" style="color:#4c4f69;background-color:#eff1f5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-scala" data-lang="scala"><span style="display:flex;"><span><span style="color:#9ca0b0;font-style:italic">/** A [[state]]ful consumer of [[SensorEvent]] detecting possible 
</span></span></span><span style="display:flex;"><span><span style="color:#9ca0b0;font-style:italic">  * malfunctioning and keeping track of last known active sensing units.
</span></span></span><span style="display:flex;"><span><span style="color:#9ca0b0;font-style:italic">  */</span>
</span></span><span style="display:flex;"><span><span style="color:#8839ef">trait</span> <span style="color:#df8e1d">SensorHealthChecker</span> <span style="color:#8839ef">extends</span> <span style="color:#df8e1d">Consumer</span><span style="color:#04a5e5;font-weight:bold">[</span><span style="color:#d20f39">Seq</span><span style="color:#04a5e5;font-weight:bold">[</span><span style="color:#d20f39">E</span><span style="color:#04a5e5;font-weight:bold">]</span>, <span style="color:#d20f39">Seq</span><span style="color:#04a5e5;font-weight:bold">[</span><span style="color:#d20f39">E</span><span style="color:#04a5e5;font-weight:bold">]]</span> <span style="color:#8839ef">with</span> <span style="color:#df8e1d">State</span><span style="color:#04a5e5;font-weight:bold">[</span><span style="color:#d20f39">Seq</span><span style="color:#04a5e5;font-weight:bold">[</span><span style="color:#d20f39">E</span><span style="color:#04a5e5;font-weight:bold">]</span>, <span style="color:#d20f39">Seq</span><span style="color:#04a5e5;font-weight:bold">[</span><span style="color:#d20f39">E</span><span style="color:#04a5e5;font-weight:bold">]]</span>
</span></span></code></pre></div></li>
<li>
<p>The <code>Thermostat</code> is a stateful consumer of temperature entries, taking care of controlling the heating system. The fact the thermostat keeps track of the last average detection could be useful to a ReSTful API, for example.</p>
<div class="highlight"><pre tabindex="0" style="color:#4c4f69;background-color:#eff1f5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-scala" data-lang="scala"><span style="display:flex;"><span><span style="color:#9ca0b0;font-style:italic">/** A [[state]]ful consumer of [[TemperatureEntry]]s in charge of controlling
</span></span></span><span style="display:flex;"><span><span style="color:#9ca0b0;font-style:italic">  * the heater and keeping track of the last detected average temperature.
</span></span></span><span style="display:flex;"><span><span style="color:#9ca0b0;font-style:italic">  */</span>
</span></span><span style="display:flex;"><span><span style="color:#8839ef">trait</span> <span style="color:#df8e1d">Thermostat</span>
</span></span><span style="display:flex;"><span>    <span style="color:#8839ef">extends</span> <span style="color:#df8e1d">Consumer</span><span style="color:#04a5e5;font-weight:bold">[</span><span style="color:#d20f39">Seq</span><span style="color:#04a5e5;font-weight:bold">[</span><span style="color:#d20f39">TemperatureEntry</span><span style="color:#04a5e5;font-weight:bold">]</span>, <span style="color:#d20f39">Option</span><span style="color:#04a5e5;font-weight:bold">[</span><span style="color:#d20f39">Temperature</span><span style="color:#04a5e5;font-weight:bold">]]</span>
</span></span><span style="display:flex;"><span>    <span style="color:#8839ef">with</span> <span style="color:#df8e1d">State</span><span style="color:#04a5e5;font-weight:bold">[</span><span style="color:#d20f39">Seq</span><span style="color:#04a5e5;font-weight:bold">[</span><span style="color:#d20f39">TemperatureEntry</span><span style="color:#04a5e5;font-weight:bold">]</span>, <span style="color:#d20f39">Option</span><span style="color:#04a5e5;font-weight:bold">[</span><span style="color:#d20f39">Temperature</span><span style="color:#04a5e5;font-weight:bold">]]</span><span style="color:#8839ef">:</span>
</span></span><span style="display:flex;"><span>  <span style="color:#d20f39">val</span> <span style="color:#d20f39">scheduler:</span> <span style="color:#d20f39">T</span>
</span></span></code></pre></div></li>
<li>
<p><code>LightingSystem</code> is a basic consumer (non-stateful) of luminosity entries, taking care of controlling the lighting system.</p>
<div class="highlight"><pre tabindex="0" style="color:#4c4f69;background-color:#eff1f5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-scala" data-lang="scala"><span style="display:flex;"><span><span style="color:#9ca0b0;font-style:italic">/** A consumer of [[LuminosityEntry]], in charge of controlling the lighting system. */</span>
</span></span><span style="display:flex;"><span><span style="color:#8839ef">trait</span> <span style="color:#df8e1d">LightingSystem</span> <span style="color:#8839ef">extends</span> <span style="color:#df8e1d">Consumer</span><span style="color:#04a5e5;font-weight:bold">[</span><span style="color:#d20f39">Seq</span><span style="color:#04a5e5;font-weight:bold">[</span><span style="color:#d20f39">LuminosityEntry</span><span style="color:#04a5e5;font-weight:bold">]</span>, <span style="color:#d20f39">Unit</span><span style="color:#04a5e5;font-weight:bold">]</span>
</span></span></code></pre></div></li>
</ul>
<p>Each of these controllers reacts to the data received based on their logic and their actual state to accomplish a specific task.
For example:</p>
<ul>
<li>
<p>the sensor checker sends alerts whether, compared with the previous detection, it did not receive data from some sensors:</p>
<div class="highlight"><pre tabindex="0" style="color:#4c4f69;background-color:#eff1f5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-scala" data-lang="scala"><span style="display:flex;"><span><span style="color:#8839ef">override</span> <span style="color:#8839ef">protected</span> <span style="color:#8839ef">def</span> react<span style="color:#04a5e5;font-weight:bold">(</span>e<span style="color:#8839ef">:</span> <span style="color:#d20f39">Try</span><span style="color:#04a5e5;font-weight:bold">[</span><span style="color:#d20f39">Seq</span><span style="color:#04a5e5;font-weight:bold">[</span><span style="color:#d20f39">E</span><span style="color:#04a5e5;font-weight:bold">]])(</span>using <span style="color:#df8e1d">Async</span><span style="color:#04a5e5;font-weight:bold">)</span><span style="color:#8839ef">:</span> <span style="color:#d20f39">Seq</span><span style="color:#04a5e5;font-weight:bold">[</span><span style="color:#d20f39">E</span><span style="color:#04a5e5;font-weight:bold">]</span> <span style="color:#8839ef">=</span> e <span style="color:#8839ef">match</span>
</span></span><span style="display:flex;"><span>  <span style="color:#8839ef">case</span> <span style="color:#df8e1d">Success</span><span style="color:#04a5e5;font-weight:bold">(</span>current<span style="color:#04a5e5;font-weight:bold">)</span> <span style="color:#8839ef">=&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#8839ef">val</span> noMoreActive <span style="color:#8839ef">=</span> state<span style="color:#04a5e5;font-weight:bold">.</span>map<span style="color:#04a5e5;font-weight:bold">(</span><span style="color:#8839ef">_</span><span style="color:#04a5e5;font-weight:bold">.</span>name<span style="color:#04a5e5;font-weight:bold">).</span>toSet <span style="color:#04a5e5;font-weight:bold">--</span> current<span style="color:#04a5e5;font-weight:bold">.</span>map<span style="color:#04a5e5;font-weight:bold">(</span><span style="color:#8839ef">_</span><span style="color:#04a5e5;font-weight:bold">.</span>name<span style="color:#04a5e5;font-weight:bold">).</span>toSet
</span></span><span style="display:flex;"><span>    <span style="color:#8839ef">if</span> noMoreActive<span style="color:#04a5e5;font-weight:bold">.</span>nonEmpty then
</span></span><span style="display:flex;"><span>      sendAlert<span style="color:#04a5e5;font-weight:bold">(</span><span style="color:#40a02b">s&#34;[</span><span style="color:#40a02b">${</span>currentTime<span style="color:#40a02b">}</span><span style="color:#40a02b">] Detected </span><span style="color:#40a02b">${</span>noMoreActive<span style="color:#04a5e5;font-weight:bold">.</span>mkString<span style="color:#04a5e5;font-weight:bold">(</span><span style="color:#40a02b">&#34;, &#34;</span><span style="color:#04a5e5;font-weight:bold">)</span><span style="color:#40a02b">}</span><span style="color:#40a02b"> no more active!&#34;</span><span style="color:#04a5e5;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>    current
</span></span><span style="display:flex;"><span>  <span style="color:#8839ef">case</span> <span style="color:#df8e1d">Failure</span><span style="color:#04a5e5;font-weight:bold">(</span>es<span style="color:#04a5e5;font-weight:bold">)</span> <span style="color:#8839ef">=&gt;</span> sendAlert<span style="color:#04a5e5;font-weight:bold">(</span>es<span style="color:#04a5e5;font-weight:bold">.</span>getMessage<span style="color:#04a5e5;font-weight:bold">);</span> <span style="color:#df8e1d">Seq</span><span style="color:#04a5e5;font-weight:bold">()</span>
</span></span></code></pre></div></li>
<li>
<p>the thermostat computes the average temperature and, based on a scheduler, decides whether to turn on or off the heating system:</p>
<div class="highlight"><pre tabindex="0" style="color:#4c4f69;background-color:#eff1f5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-scala" data-lang="scala"><span style="display:flex;"><span><span style="color:#8839ef">override</span> <span style="color:#8839ef">protected</span> <span style="color:#8839ef">def</span> react<span style="color:#04a5e5;font-weight:bold">(</span>e<span style="color:#8839ef">:</span> <span style="color:#d20f39">Try</span><span style="color:#04a5e5;font-weight:bold">[</span><span style="color:#d20f39">Seq</span><span style="color:#04a5e5;font-weight:bold">[</span><span style="color:#d20f39">TemperatureEntry</span><span style="color:#04a5e5;font-weight:bold">]])(</span>using <span style="color:#df8e1d">Async</span><span style="color:#04a5e5;font-weight:bold">)</span><span style="color:#8839ef">:</span> <span style="color:#d20f39">Option</span><span style="color:#04a5e5;font-weight:bold">[</span><span style="color:#d20f39">Temperature</span><span style="color:#04a5e5;font-weight:bold">]</span> <span style="color:#8839ef">=</span>
</span></span><span style="display:flex;"><span>  <span style="color:#8839ef">for</span>
</span></span><span style="display:flex;"><span>    averageTemperature <span style="color:#8839ef">&lt;-</span> e<span style="color:#04a5e5;font-weight:bold">.</span>map <span style="color:#04a5e5;font-weight:bold">{</span> entries <span style="color:#8839ef">=&gt;</span> entries<span style="color:#04a5e5;font-weight:bold">.</span>map<span style="color:#04a5e5;font-weight:bold">(</span><span style="color:#8839ef">_</span><span style="color:#04a5e5;font-weight:bold">.</span>temperature<span style="color:#04a5e5;font-weight:bold">).</span>sum <span style="color:#04a5e5;font-weight:bold">/</span> entries<span style="color:#04a5e5;font-weight:bold">.</span>size <span style="color:#04a5e5;font-weight:bold">}.</span>toOption
</span></span><span style="display:flex;"><span>    <span style="color:#8839ef">_</span> <span style="color:#8839ef">=</span> averageTemperature<span style="color:#04a5e5;font-weight:bold">.</span>evaluate<span style="color:#04a5e5;font-weight:bold">()</span> <span style="color:#9ca0b0;font-style:italic">// here logic to decide whether turn on or off heating system
</span></span></span><span style="display:flex;"><span><span style="color:#9ca0b0;font-style:italic"></span>  <span style="color:#8839ef">yield</span> averageTemperature
</span></span></code></pre></div></li>
</ul>
</li>
<li>
<p>The <code>HubManager</code> takes care of grouping sensor data by their type and forwarding them to the appropriate manager, either <code>ThermostatManager</code> or <code>LightingManager</code>:</p>
<div class="highlight"><pre tabindex="0" style="color:#4c4f69;background-color:#eff1f5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-scala" data-lang="scala"><span style="display:flex;"><span><span style="color:#8839ef">val</span> channelBySensor <span style="color:#8839ef">=</span> sensorsSource<span style="color:#04a5e5;font-weight:bold">.</span>publishingChannel<span style="color:#04a5e5;font-weight:bold">.</span>groupBy<span style="color:#04a5e5;font-weight:bold">(</span><span style="color:#8839ef">_</span><span style="color:#04a5e5;font-weight:bold">.</span>getClass<span style="color:#04a5e5;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#df8e1d">Task</span> <span style="color:#04a5e5;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>  channelBySensor<span style="color:#04a5e5;font-weight:bold">.</span>read<span style="color:#04a5e5;font-weight:bold">()</span> <span style="color:#8839ef">match</span>
</span></span><span style="display:flex;"><span>    <span style="color:#8839ef">case</span> <span style="color:#df8e1d">Right</span><span style="color:#04a5e5;font-weight:bold">((</span>clazz<span style="color:#04a5e5;font-weight:bold">,</span> c<span style="color:#04a5e5;font-weight:bold">))</span> <span style="color:#8839ef">if</span> clazz <span style="color:#04a5e5;font-weight:bold">==</span> classOf<span style="color:#04a5e5;font-weight:bold">[</span><span style="color:#d20f39">TemperatureEntry</span><span style="color:#04a5e5;font-weight:bold">]</span> <span style="color:#8839ef">=&gt;</span>
</span></span><span style="display:flex;"><span>      thermostatManager<span style="color:#04a5e5;font-weight:bold">.</span>run<span style="color:#04a5e5;font-weight:bold">(</span>c<span style="color:#04a5e5;font-weight:bold">.</span>asInstanceOf<span style="color:#04a5e5;font-weight:bold">[</span><span style="color:#d20f39">ReadableChannel</span><span style="color:#04a5e5;font-weight:bold">[</span><span style="color:#d20f39">TemperatureEntry</span><span style="color:#04a5e5;font-weight:bold">]])</span>
</span></span><span style="display:flex;"><span>    <span style="color:#8839ef">case</span> <span style="color:#df8e1d">Right</span><span style="color:#04a5e5;font-weight:bold">((</span>clazz<span style="color:#04a5e5;font-weight:bold">,</span> c<span style="color:#04a5e5;font-weight:bold">))</span> <span style="color:#8839ef">if</span> clazz <span style="color:#04a5e5;font-weight:bold">==</span> classOf<span style="color:#04a5e5;font-weight:bold">[</span><span style="color:#d20f39">LuminosityEntry</span><span style="color:#04a5e5;font-weight:bold">]</span> <span style="color:#8839ef">=&gt;</span>
</span></span><span style="display:flex;"><span>      lightingManager<span style="color:#04a5e5;font-weight:bold">.</span>run<span style="color:#04a5e5;font-weight:bold">(</span>c<span style="color:#04a5e5;font-weight:bold">.</span>asInstanceOf<span style="color:#04a5e5;font-weight:bold">[</span><span style="color:#d20f39">ReadableChannel</span><span style="color:#04a5e5;font-weight:bold">[</span><span style="color:#d20f39">LuminosityEntry</span><span style="color:#04a5e5;font-weight:bold">]])</span>
</span></span><span style="display:flex;"><span>    <span style="color:#8839ef">case</span> <span style="color:#8839ef">_</span> <span style="color:#8839ef">=&gt;</span> <span style="color:#04a5e5;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span><span style="color:#04a5e5;font-weight:bold">}.</span>schedule<span style="color:#04a5e5;font-weight:bold">(</span><span style="color:#df8e1d">RepeatUntilFailure</span><span style="color:#04a5e5;font-weight:bold">()).</span>run
</span></span><span style="display:flex;"><span>sensorsSource<span style="color:#04a5e5;font-weight:bold">.</span>asRunnable<span style="color:#04a5e5;font-weight:bold">.</span>run<span style="color:#04a5e5;font-weight:bold">.</span>await
</span></span></code></pre></div></li>
<li>
<p>Both <code>ThermostatManager</code> and <code>LightingManager</code> are in charge of creating the appropriate <code>Controller</code> instance, based on the number of <code>Consumer</code>s and pipeline transformation we need to implement:</p>
<div class="highlight"><pre tabindex="0" style="color:#4c4f69;background-color:#eff1f5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-scala" data-lang="scala"><span style="display:flex;"><span><span style="color:#9ca0b0;font-style:italic">// ThermostatManager
</span></span></span><span style="display:flex;"><span><span style="color:#9ca0b0;font-style:italic"></span><span style="color:#8839ef">def</span> run<span style="color:#04a5e5;font-weight:bold">(</span>source<span style="color:#8839ef">:</span> <span style="color:#d20f39">ReadableChannel</span><span style="color:#04a5e5;font-weight:bold">[</span><span style="color:#d20f39">TemperatureEntry</span><span style="color:#04a5e5;font-weight:bold">])(</span>using <span style="color:#df8e1d">Async</span><span style="color:#04a5e5;font-weight:bold">,</span> <span style="color:#df8e1d">AsyncOperations</span><span style="color:#04a5e5;font-weight:bold">)</span><span style="color:#8839ef">:</span> <span style="color:#d20f39">Unit</span> <span style="color:#04a5e5;font-weight:bold">=</span>
</span></span><span style="display:flex;"><span>  thermostat<span style="color:#04a5e5;font-weight:bold">.</span>asRunnable<span style="color:#04a5e5;font-weight:bold">.</span>run
</span></span><span style="display:flex;"><span>  sensorHealthChecker<span style="color:#04a5e5;font-weight:bold">.</span>asRunnable<span style="color:#04a5e5;font-weight:bold">.</span>run
</span></span><span style="display:flex;"><span>  <span style="color:#df8e1d">Controller</span><span style="color:#04a5e5;font-weight:bold">.</span>oneToMany<span style="color:#04a5e5;font-weight:bold">(</span>
</span></span><span style="display:flex;"><span>    publisherChannel <span style="color:#8839ef">=</span> source<span style="color:#04a5e5;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>    consumers <span style="color:#8839ef">=</span> <span style="color:#df8e1d">Set</span><span style="color:#04a5e5;font-weight:bold">(</span>thermostat<span style="color:#04a5e5;font-weight:bold">,</span> sensorHealthChecker<span style="color:#04a5e5;font-weight:bold">),</span>
</span></span><span style="display:flex;"><span>    transformation <span style="color:#8839ef">=</span> r <span style="color:#8839ef">=&gt;</span> r<span style="color:#04a5e5;font-weight:bold">.</span>bufferWithin<span style="color:#04a5e5;font-weight:bold">(</span>samplingWindow<span style="color:#04a5e5;font-weight:bold">),</span>
</span></span><span style="display:flex;"><span>  <span style="color:#04a5e5;font-weight:bold">).</span>run
</span></span></code></pre></div></li>
</ul>
<p>To produce a testable version of this example, a simulated source of sensor data has been created, backed to a GUI, through which the user can simulate the behavior of the sensors.
The example is runnable via:</p>
<div class="highlight"><pre tabindex="0" style="color:#4c4f69;background-color:#eff1f5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>./gradlew smart-hub-direct:run
</span></span></code></pre></div><p>Three panels should pop up, one for each sensor type, and a dashboard showing the state of the system.
Entering some value in the panels and pressing the &ldquo;Send&rdquo; button, after 5 seconds (the configured sampling window), the system should react to the data received, updating the dashboard with the new state.</p>
<figure><img src="../../res/img/smart-hub.png"
         alt="Smart Hub application" width="90%"/>
</figure>

<h3 id="kotlin-coroutines-version">
  Kotlin Coroutines version
  <a class="anchor" href="#kotlin-coroutines-version">#</a>
</h3>
<p>Kotlin Coroutines offers two other abstractions to deal with asynchronous data streams, belonging to the <code>flow</code> &ldquo;family&rdquo;, which are: <code>SharedFlow</code> and <code>StateFlow</code>.
Despite their names including <code>flow</code>, which we&rsquo;ve seen are cold streams, they are actually <strong>hot</strong> (the terminology is a bit misleading&hellip;):</p>
<ul>
<li><code>SharedFlow</code> is a hot flow that allows for multiple collectors to subscribe to it, enabling the broadcasting of values to multiple consumers or having multiple consumers be &ldquo;attached&rdquo; to the same stream of data.
<ul>
<li>they can be configured to buffer a certain number of previously emitted values for new collectors so that they can catch up with the latest values &ndash; the so-called, <code>replay</code> cache;</li>
</ul>
</li>
<li><code>StateFlow</code> is an extension of the <code>SharedFlow</code>: it is a hot flow that maintains a single value representing a state, holding one value at a time. It operates as a conflated flow, meaning that when a new value is emitted, it replaces the previous value and is immediately sent to new collectors
<ul>
<li>this type of flow is beneficial for maintaining a single source of truth for a state and automatically updating all collectors with the latest state (for example in ViewModels in Android applications)</li>
</ul>
</li>
</ul>
<p>In our example, <code>SharedFlow</code> is used to model the flow of sensor data:</p>
<div class="highlight"><pre tabindex="0" style="color:#4c4f69;background-color:#eff1f5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-kotlin" data-lang="kotlin"><span style="display:flex;"><span><span style="color:#8839ef">interface</span> <span style="color:#df8e1d">SensorSource</span>&lt;<span style="color:#8839ef">out</span> E : SensorEvent&gt; {
</span></span><span style="display:flex;"><span>    <span style="color:#9ca0b0;font-style:italic">/** The flow of sensor events. */</span>
</span></span><span style="display:flex;"><span>    <span style="color:#8839ef">val</span> <span style="color:#fe640b">sensorEvents</span>: SharedFlow&lt;E&gt;
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>Like all flows, they have all the kinds of operators presented in the previous example. Despite this, they do not support, at the moment, all the operators that Rx offers, like <code>groupBy</code>, <code>buffer</code> (in the Rx conception), etc&hellip; (even if some proposals are pending to add them in the framework).</p>
<p>For this reason, the consumer of events has been implemented manually, using a loop that, every <code>samplingWindow</code> time, reacts to the data received, updating the state of the system.
By the way, if this solution appears to be less elegant, since <code>Flow</code>s are, de facto, the porting of Rx&rsquo;s <code>Observable's</code> into the Coroutines world, <a href="https://kotlinlang.org/api/kotlinx.coroutines/kotlinx-coroutines-rx2/">libraries exists to convert them to <code>Observable</code> and vice versa</a>.
This could offer (in some cases and where necessary) a way to use the full power of Rx operator, if needed.</p>
<div class="highlight"><pre tabindex="0" style="color:#4c4f69;background-color:#eff1f5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-kotlin" data-lang="kotlin"><span style="display:flex;"><span><span style="color:#9ca0b0;font-style:italic">/** A consumer of sensor events. */</span>
</span></span><span style="display:flex;"><span><span style="color:#8839ef">interface</span> <span style="color:#df8e1d">SensorSourceConsumer</span>&lt;<span style="color:#8839ef">in</span> E : SensorEvent, <span style="color:#8839ef">out</span> S&gt; {
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#9ca0b0;font-style:italic">/** The current state of the source consumer. */</span>
</span></span><span style="display:flex;"><span>    <span style="color:#8839ef">val</span> <span style="color:#fe640b">state</span>: S
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#9ca0b0;font-style:italic">/** Reacts to a sensor event. */</span>
</span></span><span style="display:flex;"><span>    <span style="color:#8839ef">suspend</span> <span style="color:#8839ef">fun</span> <span style="color:#1e66f5">react</span>(e: E)
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#9ca0b0;font-style:italic">/** A scheduled consumer of sensor events. */</span>
</span></span><span style="display:flex;"><span><span style="color:#8839ef">interface</span> <span style="color:#df8e1d">ScheduledConsumer</span>&lt;<span style="color:#8839ef">in</span> E : SensorEvent, <span style="color:#8839ef">out</span> S&gt; : SensorSourceConsumer&lt;E, S&gt;, CoroutineScope {
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#9ca0b0;font-style:italic">/** The interval period. */</span>
</span></span><span style="display:flex;"><span>    <span style="color:#8839ef">val</span> <span style="color:#fe640b">samplingWindow</span>: Duration
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#9ca0b0;font-style:italic">/** The update logic of the consumer. */</span>
</span></span><span style="display:flex;"><span>    <span style="color:#8839ef">suspend</span> <span style="color:#8839ef">fun</span> <span style="color:#1e66f5">update</span>()
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#9ca0b0;font-style:italic">/** Runs the consumer scheduler. */</span>
</span></span><span style="display:flex;"><span>    <span style="color:#8839ef">fun</span> <span style="color:#1e66f5">run</span>() = launch {
</span></span><span style="display:flex;"><span>        <span style="color:#8839ef">while</span> (<span style="color:#8839ef">true</span>) {
</span></span><span style="display:flex;"><span>            update()
</span></span><span style="display:flex;"><span>            delay(samplingWindow)
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>The managers just take care of collecting the data and forwarding it to the appropriate consumer. For example, the <code>ThermostatManager</code>:</p>
<div class="highlight"><pre tabindex="0" style="color:#4c4f69;background-color:#eff1f5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-kotlin" data-lang="kotlin"><span style="display:flex;"><span><span style="color:#8839ef">suspend</span> <span style="color:#8839ef">fun</span> <span style="color:#1e66f5">run</span>(sensorSource: Flow&lt;TemperatureEntry&gt;) {
</span></span><span style="display:flex;"><span>    thermostat.run()
</span></span><span style="display:flex;"><span>    temperatureSensorsChecker.run()
</span></span><span style="display:flex;"><span>    sensorSource.collect {
</span></span><span style="display:flex;"><span>        thermostat.react(<span style="color:#8839ef">it</span>)
</span></span><span style="display:flex;"><span>        temperatureSensorsChecker.react(<span style="color:#8839ef">it</span>)
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><h2 id="conclusions">
  Conclusions
  <a class="anchor" href="#conclusions">#</a>
</h2>
</article>
 
      

      <footer class="book-footer">
        
  <div class="flex flex-wrap justify-between">


  <div><a class="flex align-center" href="https://github.com/tassiLuca/PPS-22-direct-style-experiments/commit/5c16fe7aeb16ff94f159640d51b9c5f1c4d321b5" title='Last modified by Luca Tassinari | March 4, 2024' target="_blank" rel="noopener">
      <img src="/PPS-22-direct-style-experiments/svg/calendar.svg" class="book-icon" alt="Calendar" />
      <span>March 4, 2024</span>
    </a>
  </div>




</div>



  <script>(function(){function e(e){const t=window.getSelection(),n=document.createRange();n.selectNodeContents(e),t.removeAllRanges(),t.addRange(n)}document.querySelectorAll("pre code").forEach(t=>{t.addEventListener("click",function(){if(window.getSelection().toString())return;e(t.parentElement),navigator.clipboard&&navigator.clipboard.writeText(t.parentElement.textContent)})})})()</script>


 
        
      </footer>

      
  
  <div class="book-comments">

</div>
  
 

      <label for="menu-control" class="hidden book-menu-overlay"></label>
    </div>

    
  </main>

  
</body>
</html>












